# Trivy + CodeQL: Deep security scan — Misconfig, IaC, Secrets, ECR, SBOM, HTML report, SAST (CodeQL)

name: Trivy & CodeQL Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      ecr_image:
        description: 'ECR image to scan (optional). e.g. 123456789.dkr.ecr.region.amazonaws.com/repo:tag'
        required: false
        type: string

env:
  TRIVY_VERSION: "v0.68.1"
  SEVERITY_LIST: "CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN"  # Critical → Informational order

jobs:
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java
          build-mode: none
          config-file: .github/codeql/codeql-config.yml

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: codeql-java

  scan:
    name: Trivy Deep Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- 1. Repo scan: Misconfig + Secrets + Vulns (SARIF for Security tab) ---
      - name: Trivy — FS (misconfig, secrets, vuln)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-fs.sarif
          severity: ${{ env.SEVERITY_LIST }}
          scanners: vuln,secret,misconfig
          exit-code: "0"
        continue-on-error: true

      # --- 2. IaC: Terraform, Docker, Kubernetes ---
      - name: Trivy — IaC (Terraform, Docker, K8s)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: .
          format: sarif
          output: trivy-iac.sarif
          severity: ${{ env.SEVERITY_LIST }}
          exit-code: "0"
        continue-on-error: true

      # --- 3. SBOM ---
      - name: Trivy — SBOM
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          format: cyclonedx
          output: trivy-sbom.json
          exit-code: "0"
        continue-on-error: true

      # --- 4. ECR image (when provided via workflow_dispatch) ---
      - name: Trivy — ECR image
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ecr_image != '' }}
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: image
          image-ref: ${{ github.event.inputs.ecr_image }}
          format: sarif
          output: trivy-ecr.sarif
          severity: ${{ env.SEVERITY_LIST }}
          exit-code: "0"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION || 'us-east-1' }}
        continue-on-error: true

      # --- 5. HTML report (Critical → Informational) ---
      - name: Trivy — HTML report
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          format: template
          template: "@$HOME/.local/bin/trivy-bin/contrib/html.tpl"
          output: trivy-report.html
          severity: ${{ env.SEVERITY_LIST }}
          scanners: vuln,secret,misconfig
          exit-code: "0"
        continue-on-error: true

      # --- Ensure SARIF files exist for upload ---
      - name: Ensure SARIF files exist
        if: always()
        run: |
          EMPTY='{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"trivy","version":"0.0","rules":[]}},"results":[]}]}'
          [ -f trivy-fs.sarif ] || echo "$EMPTY" > trivy-fs.sarif
          [ -f trivy-iac.sarif ] || echo "$EMPTY" > trivy-iac.sarif
          [ -f trivy-ecr.sarif ] || echo "$EMPTY" > trivy-ecr.sarif

      # --- Upload SARIF to Security tab ---
      - name: Upload SARIF — FS
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-fs.sarif
          category: trivy-fs
      - name: Upload SARIF — IaC
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-iac.sarif
          category: trivy-iac
      - name: Upload SARIF — ECR
        if: always() && github.event_name == 'workflow_dispatch' && github.event.inputs.ecr_image != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-ecr.sarif
          category: trivy-ecr

      # --- Artifact: HTML report + SBOM (download = “HTML link”) ---
      - name: Ensure report files exist
        if: always()
        run: |
          [ -f trivy-report.html ] || echo '<!DOCTYPE html><html><body><p>No Trivy report generated. Check scan steps.</p></body></html>' > trivy-report.html
          [ -f trivy-sbom.json ] || echo '{"bomFormat":"CycloneDX","specVersion":"1.4","version":1,"components":[]}' > trivy-sbom.json

      - name: Upload Trivy report & SBOM
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report-${{ github.run_number }}
          path: |
            trivy-report.html
            trivy-sbom.json
          retention-days: 30

      # --- Summary with link to run (and artifact) ---
      - name: Summary
        if: always()
        run: |
          echo "## Trivy Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Vulnerabilities (order)** | CRITICAL → HIGH → MEDIUM → LOW → UNKNOWN (Informational) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Scans** | Trivy: Misconfig, IaC, Secrets, ECR, SBOM. CodeQL: Java SAST (security-extended) |" >> $GITHUB_STEP_SUMMARY
          echo "| **HTML report** | Download \`trivy-report-${{ github.run_number }}\` artifact → open \`trivy-report.html\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **SBOM** | \`trivy-sbom.json\` (CycloneDX) in the same artifact |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Open this run to download the HTML report:** [Run #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Code Scanning: [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
